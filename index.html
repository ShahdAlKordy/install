<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูููุฉ ุจูุชู - ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .sidebar { background-color: #142952; }
        .active-tab { background-color: rgba(255, 255, 255, 0.1); border-left: 4px solid white; }
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .invoice-page { page-break-after: always; border: none !important; box-shadow: none !important; padding: 20px !important; }
        }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #142952; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="sidebar w-64 text-white fixed h-full flex flex-col no-print z-20">
            <div class="p-8 border-b border-white/5 flex flex-col items-center">
                <div class="w-20 h-20 bg-white rounded-2xl mb-4 flex items-center justify-center overflow-hidden p-2">
                    <img src="https://i.ibb.co/68vD84D/logo1.png" alt="Logo" class="w-full h-full object-contain">
                </div>
                <h1 class="text-xl font-black">ูููุฉ ุจูุชู</h1>
                <p class="text-blue-300 text-[10px] mt-1">ูุธุงู ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</p>
            </div>
            
            <nav class="flex-1 py-10 px-4 space-y-2">
                <button @click="activeTab = 'create'" :class="{'active-tab': activeTab === 'create'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> ุชุณุฌูู ุทูุจ
                </button>
                <button @click="activeTab = 'archive'" :class="{'active-tab': activeTab === 'archive'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="database" class="w-5 h-5"></i> ุฃุฑุดูู ุงูุทูุจุงุช
                </button>
                <button @click="activeTab = 'invoices'" :class="{'active-tab': activeTab === 'invoices'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="file-text" class="w-5 h-5"></i> ููุงุชูุฑ ุงูููู
                </button>
                <button @click="activeTab = 'catalog'" :class="{'active-tab': activeTab === 'catalog'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="settings" class="w-5 h-5"></i> ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 mr-64 p-8 no-print">
            <!-- Loading Overlay -->
            <div v-if="loading" class="fixed inset-0 bg-white/80 z-50 flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-[#142952]"></div>
                <p class="mt-4 font-bold text-[#142952]">ุฌุงุฑู ูุฒุงููุฉ ุงูุจูุงูุงุช...</p>
            </div>

            <!-- Header -->
            <header class="mb-10">
                <h2 class="text-3xl font-black text-[#142952]">
                    <span v-if="activeTab === 'create'">ุชุณุฌูู ุทูุจ ุฌุฏูุฏ</span>
                    <span v-if="activeTab === 'archive'">ุฃุฑุดูู ูุงูุฉ ุงูุทูุจุงุช</span>
                    <span v-if="activeTab === 'invoices'">ุฅุตุฏุงุฑ ูููุชุฑุฉ ุงูููุงุชูุฑ</span>
                    <span v-if="activeTab === 'catalog'">ุฅุฏุงุฑุฉ ูุชุงููุฌ ุงูููุชุฌุงุช</span>
                </h2>
                <p class="text-gray-500">ูุฑุญุจุงู ุจูู ูุง ุดูุฏ ูู ููุญุฉ ุชุญูู "ูููุฉ ุจูุชู"</p>
            </header>

            <!-- Notification -->
            <div v-if="notification" class="fixed top-8 left-8 z-50 p-4 rounded-2xl shadow-2xl bg-white border-l-8 flex items-center gap-3 animate-in" :class="notification.type === 'error' ? 'border-red-500 text-red-600' : 'border-green-500 text-green-600'">
                <i v-if="notification.type === 'success'" data-lucide="check-circle"></i>
                <i v-else data-lucide="alert-circle"></i>
                <span class="font-bold">{{ notification.msg }}</span>
            </div>

            <!-- Views -->
            <!-- 1. Create Order -->
            <section v-if="activeTab === 'create'" class="animate-in bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <form @submit.prevent="saveOrder" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-2xl">
                        <div class="col-span-full font-bold text-[#142952] mb-2 flex items-center gap-2">
                            <i data-lucide="user" class="w-4 h-4"></i> ุจูุงูุงุช ุงูุนููู ุงูุฃุณุงุณูุฉ
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">ุงุณู ุงูุนููู</label>
                            <input v-model="orderForm.client.name" required class="w-full p-2.5 border rounded-xl" placeholder="ุงูุงุณู ุงูุฑุจุงุนู">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">ุงููุฏููุฉ</label>
                            <input v-model="orderForm.client.city" required class="w-full p-2.5 border rounded-xl" placeholder="ูุซุงู: ุงูุฑูุงุถ">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">ุงูุฌูุงู</label>
                            <input v-model="orderForm.client.phone" required class="w-full p-2.5 border rounded-xl" placeholder="05xxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">ุงูุนููุงู ุจุงูุชูุตูู</label>
                            <input v-model="orderForm.client.address" required class="w-full p-2.5 border rounded-xl" placeholder="ุงูุญูุ ุงูุดุงุฑุนุ ุงููุนุงูู">
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="flex justify-between items-center border-b-2 border-gray-100 pb-2">
                            <h3 class="font-bold text-[#142952] flex items-center gap-2">
                                <i data-lucide="shopping-bag" class="w-5 h-5"></i> ูุงุฆูุฉ ุงูููุชุฌุงุช ุงููุทููุจุฉ
                            </h3>
                            <button type="button" @click="addProductRow" class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-100 transition-all">+ ุฅุถุงูุฉ ููุชุฌ ุขุฎุฑ</button>
                        </div>
                        
                        <div v-for="(p, index) in orderForm.products" :key="p.id" class="p-6 border-2 border-gray-50 rounded-2xl bg-white relative hover:border-blue-100 transition-all shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">ุงูููุชุฌ</label>
                                    <select v-model="p.productId" @change="syncProductData(p)" required class="w-full p-2.5 border rounded-xl text-sm bg-gray-50 font-bold">
                                        <option value="">ุงุฎุชุฑ ุงูููุชุฌ...</option>
                                        <option v-for="item in catalog" :value="item.id">{{ item.name }} ({{ item.price }} SAR)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">ุงูููู</label>
                                    <select v-model="p.color" class="w-full p-2.5 border rounded-xl text-sm">
                                        <option value="silver">ุณูููุฑ (ูุถู)</option>
                                        <option value="gold">ุฌููุฏ (ุฐูุจู)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">ุงููููุฉ</label>
                                    <input v-model.number="p.count" type="number" min="1" class="w-full p-2.5 border rounded-xl text-sm">
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-[#142952] uppercase mb-1 font-black">ุงูุนููุงู ุงููุทูู</label>
                                    <input v-model="p.nationalAddress" class="w-full p-2.5 border border-blue-200 rounded-xl text-sm bg-blue-50/30" placeholder="ุงูุฑูุฒ ุงููุทูู">
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">ุฑูู ุงููููุง/ุงูุจุงุจ</label>
                                    <input v-model="p.villaNo" class="w-full p-2.5 border rounded-xl text-sm">
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">ุงูุงุณู ุงููุฎุตุต</label>
                                    <input v-model="p.customName" class="w-full p-2.5 border rounded-xl text-sm" placeholder="ุงูุงุณู ุงูููุชูุจ">
                                </div>
                                <div class="lg:col-span-2">
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                                    <input v-model="p.notes" class="w-full p-2.5 border rounded-xl text-sm" placeholder="ุฃู ุชูุงุตูู ุฃุฎุฑู...">
                                </div>
                            </div>
                            <button v-if="orderForm.products.length > 1" @click="removeProductRow(index)" type="button" class="absolute -top-3 -left-3 bg-red-50 text-red-500 p-2 rounded-full border border-red-100 hover:bg-red-500 hover:text-white transition-all shadow-sm">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t border-gray-100 pt-8">
                        <div class="text-[#142952]">
                            <p class="text-sm font-bold">ุฅุฌูุงูู ุงูุทูุจ ุงูุชูุฑูุจู:</p>
                            <p class="text-3xl font-black text-green-600">{{ calculateTotal() }} SAR</p>
                        </div>
                        <button type="submit" :disabled="isSaving" class="bg-[#142952] text-white px-12 py-5 rounded-2xl font-black shadow-2xl hover:scale-105 active:scale-95 transition-all disabled:opacity-50 flex items-center gap-3">
                            <span v-if="isSaving">ุฌุงุฑู ุงูุญูุธ...</span>
                            <span v-else>ุชุฃููุฏ ูุญูุธ ุงูุทูุจ</span>
                        </button>
                    </div>
                </form>
            </section>

            <!-- 2. Archive -->
            <section v-if="activeTab === 'archive'" class="animate-in bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50/50">
                    <div class="relative w-80">
                        <i data-lucide="search" class="absolute right-3 top-2.5 text-gray-400 w-4 h-4"></i>
                        <input v-model="searchQuery" class="w-full pr-10 pl-4 py-2.5 bg-white border rounded-full text-sm outline-none shadow-sm" placeholder="ุงุจุญุซ ุจุงูุงุณูุ ุฑูู ุงูุทูุจุ ุฃู ุงูุฌูุงู...">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-sm border-collapse">
                        <thead class="bg-[#142952] text-white">
                            <tr>
                                <th class="p-4">ุฑูู ุงูุทูุจ</th>
                                <th class="p-4">ุชุงุฑูุฎ ุงูุชุณุฌูู</th>
                                <th class="p-4">ุงูุนููู ูุงูุฌูุงู</th>
                                <th class="p-4">ุงูุนููุงู ุงูุชูุตููู</th>
                                <th class="p-4">ุงููุจูุบ</th>
                                <th class="p-4 text-center">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in filteredOrders" :key="order.id" class="border-b hover:bg-blue-50/30 transition-all">
                                <td class="p-4 font-mono font-bold text-blue-700">{{ order.orderId }}</td>
                                <td class="p-4">
                                    <div class="font-bold">{{ formatDate(order.timestamp) }}</div>
                                    <div class="text-[10px] text-gray-400">{{ formatTime(order.timestamp) }}</div>
                                </td>
                                <td class="p-4">
                                    <div class="font-bold">{{ order.client.name }}</div>
                                    <div class="text-xs text-gray-500">{{ order.client.phone }}</div>
                                </td>
                                <td class="p-4 max-w-xs truncate" :title="order.client.address">{{ order.client.address }}</td>
                                <td class="p-4 font-black text-green-600">{{ order.totalAmount }} SAR</td>
                                <td class="p-4">
                                    <div class="flex justify-center gap-2">
                                        <button @click="viewInvoice(order)" class="p-2.5 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                        <button @click="deleteOrder(order.id)" class="p-2.5 bg-red-50 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="filteredOrders.length === 0">
                                <td colspan="6" class="p-10 text-center text-gray-400 font-bold italic">ูุง ุชูุฌุฏ ุทูุจุงุช ูุทุงุจูุฉ ููุจุญุซ</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 3. Invoices (Filter by Date) -->
            <section v-if="activeTab === 'invoices'" class="animate-in space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <label class="font-black text-[#142952]">ุนุฑุถ ููุงุชูุฑ ุชุงุฑูุฎ:</label>
                        <input type="date" v-model="filterDate" class="border-2 border-blue-50 p-2.5 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                    </div>
                    <button @click="printBulk" class="bg-[#142952] text-white px-8 py-3 rounded-xl font-black flex items-center gap-3 shadow-lg hover:shadow-2xl transition-all">
                        <i data-lucide="printer" class="w-5 h-5"></i> ุทุจุงุนุฉ ููุงุชูุฑ ูุฐุง ุงูููู ุจุงููุงูู
                    </button>
                </div>

                <div v-if="filteredByDateOrders.length === 0" class="text-center py-24 bg-white rounded-3xl border-4 border-dashed border-gray-50">
                    <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="calendar-x" class="text-gray-300 w-10 h-10"></i>
                    </div>
                    <p class="text-gray-400 font-bold text-lg">ูุง ุชูุฌุฏ ุทูุจุงุช ูุณุฌูุฉ ูู ุงูุชุงุฑูุฎ ุงููุฎุชุงุฑ</p>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="order in filteredByDateOrders" :key="order.id" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:border-blue-400 transition-all cursor-pointer group" @click="viewInvoice(order)">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black tracking-widest">{{ order.orderId }}</span>
                            <span class="text-[10px] font-bold text-gray-300">{{ formatTime(order.timestamp) }}</span>
                        </div>
                        <h4 class="font-black text-[#142952] text-lg mb-1">{{ order.client.name }}</h4>
                        <p class="text-xs text-gray-500 mb-4 line-clamp-1">๐ {{ order.client.city }} - {{ order.client.address }}</p>
                        <div class="flex justify-between items-center border-t border-dashed pt-4">
                            <span class="font-black text-green-600 text-lg">{{ order.totalAmount }} SAR</span>
                            <div class="text-blue-600 font-bold text-sm flex items-center gap-1 group-hover:gap-2 transition-all">ูุนุงููุฉ <i data-lucide="chevron-left" class="w-4 h-4"></i></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Catalog -->
            <section v-if="activeTab === 'catalog'" class="animate-in bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <form @submit.prevent="saveCatalogItem" class="flex flex-wrap gap-4 mb-10 items-end bg-blue-50/30 p-8 rounded-3xl border border-blue-50">
                    <div class="flex-1 min-w-[250px]">
                        <label class="block text-xs font-bold text-[#142952] mb-1">ุงุณู ุงูููุชุฌ ุงูุฌุฏูุฏ</label>
                        <input v-model="catalogForm.name" required class="w-full p-3 bg-white border-none rounded-xl shadow-inner outline-none" placeholder="ูุซุงู: ููุญุฉ ุนููุงู ุฃูุฑูููู">
                    </div>
                    <div class="w-40">
                        <label class="block text-xs font-bold text-[#142952] mb-1">ุงูุณุนุฑ (ุฑูุงู)</label>
                        <input v-model.number="catalogForm.price" required type="number" class="w-full p-3 bg-white border-none rounded-xl shadow-inner outline-none">
                    </div>
                    <button type="submit" class="bg-[#142952] text-white px-10 py-3.5 rounded-xl font-black h-[52px] shadow-lg">ุฅุถุงูุฉ ูููุชุฌุฑ</button>
                </form>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="item in catalog" :key="item.id" class="p-6 bg-white border-2 border-gray-50 rounded-2xl flex justify-between items-center hover:border-blue-200 hover:shadow-xl transition-all">
                        <div>
                            <h5 class="font-black text-[#142952] text-lg">{{ item.name }}</h5>
                            <p class="text-blue-600 font-black">{{ item.price }} ุฑูุงู ุณุนูุฏู</p>
                        </div>
                        <button @click="deleteCatalogItem(item.id)" class="text-red-400 p-3 hover:bg-red-50 rounded-2xl transition-colors">
                            <i data-lucide="trash-2" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Print View -->
        <div id="print-area" class="hidden print-area" dir="rtl">
            <div v-for="invoice in bulkList" :key="invoice.id" class="invoice-page bg-white p-16 max-w-5xl mx-auto mb-10">
                <div class="flex justify-between items-start mb-16 pb-12 border-b-4 border-[#142952]">
                    <div>
                        <h1 class="text-6xl font-black text-[#142952] mb-4">ูุงุชูุฑุฉ</h1>
                        <div class="space-y-1 text-gray-600 font-bold">
                            <p>ุฑูู ุงููุงุชูุฑุฉ: <span class="text-black">#{{ invoice.orderId }}</span></p>
                            <p>ุชุงุฑูุฎ ุงูุทูุจ: {{ formatDate(invoice.timestamp) }}</p>
                            <p>ุงูุฑูู ุงูุถุฑูุจู: 310236446600003</p>
                        </div>
                    </div>
                    <div class="text-left flex flex-col items-end">
                        <div class="w-32 h-32 bg-[#142952] rounded-3xl mb-4 flex items-center justify-center p-4">
                            <img src="https://i.ibb.co/68vD84D/logo1.png" alt="Logo" class="w-full h-full object-contain filter invert">
                        </div>
                        <p class="font-black text-2xl text-[#142952]">ูููุฉ ุจูุชู</p>
                        <p class="text-gray-500 font-bold">ูููุญุงุช ุงูุนููุงู ุงููุงุฎุฑุฉ</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-12 mb-16">
                    <div class="bg-gray-50 p-8 rounded-3xl border border-gray-100">
                        <h3 class="font-black text-[#142952] border-b-2 border-gray-200 mb-4 pb-2 text-xl">ุจูุงูุงุช ุงูุนููู</h3>
                        <p class="font-black text-2xl mb-2">{{ invoice.client.name }}</p>
                        <p class="text-lg text-gray-700">{{ invoice.client.city }}</p>
                        <p class="text-lg font-black text-[#142952] mt-2">{{ invoice.client.address }}</p>
                        <p class="text-xl mt-4 font-bold" dir="ltr">{{ invoice.client.phone }}</p>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-3xl border border-gray-100">
                        <h3 class="font-black text-[#142952] border-b-2 border-gray-200 mb-4 pb-2 text-xl">ุชูุงุตูู ุงููุชุฌุฑ</h3>
                        <p class="font-black text-xl">ูุชุฌุฑ ูููุฉ ุจูุชู ุงูุฅููุชุฑููู</p>
                        <p class="text-lg text-gray-600">ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉุ ุงูุฑูุงุถ</p>
                        <p class="text-lg font-bold mt-2">hwytbytk@gmail.com</p>
                        <p class="text-lg mt-1" dir="ltr">+966 54 478 2301</p>
                    </div>
                </div>

                <table class="w-full mb-12 border-collapse overflow-hidden rounded-3xl border-2 border-gray-50">
                    <thead class="bg-[#142952] text-white">
                        <tr>
                            <th class="p-6 text-right text-lg">ุงูููุชุฌ ูุงูุชูุงุตูู ุงููุฎุตุตุฉ</th>
                            <th class="p-6 text-center text-lg">ุงููููุฉ</th>
                            <th class="p-6 text-left text-lg">ุงููุฌููุน</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in invoice.products" class="border-b-2 border-gray-50 bg-white">
                            <td class="p-6">
                                <div class="font-black text-xl text-gray-900 mb-1">{{ p.name }}</div>
                                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                    <span class="bg-gray-100 px-3 py-1 rounded-full font-bold">ุงูููู: {{ p.color === 'silver' ? 'ุณูููุฑ' : 'ุฌููุฏ' }}</span>
                                    <span v-if="p.nationalAddress" class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-black">ุงูุนููุงู ุงููุทูู: {{ p.nationalAddress }}</span>
                                    <span v-if="p.villaNo" class="bg-gray-100 px-3 py-1 rounded-full font-bold">ูููุง/ุจุงุจ: {{ p.villaNo }}</span>
                                </div>
                                <div v-if="p.customName" class="mt-3 text-[#142952] font-black italic border-r-4 border-blue-500 pr-3">
                                    ุงูุงุณู ุนูู ุงูููุญุฉ: {{ p.customName }}
                                </div>
                                <div v-if="p.notes" class="mt-2 text-gray-400 text-xs font-bold pr-3">ููุงุญุธุฉ: {{ p.notes }}</div>
                            </td>
                            <td class="p-6 text-center text-2xl font-black text-[#142952]">{{ p.count }}</td>
                            <td class="p-6 text-left font-black text-2xl text-green-700">{{ p.price * p.count }} SAR</td>
                        </tr>
                    </tbody>
                </table>

                <div class="flex justify-end">
                    <div class="w-80 bg-[#142952] text-white p-8 rounded-3xl shadow-2xl space-y-4">
                        <div class="flex justify-between border-b border-white/10 pb-2">
                            <span class="font-bold opacity-70">ุงููุฌููุน ุงููุฑุนู</span>
                            <span class="font-black text-xl">{{ invoice.totalAmount }} SAR</span>
                        </div>
                        <div class="flex justify-between border-b border-white/10 pb-2">
                            <span class="font-bold opacity-70">ุชูููุฉ ุงูุดุญู</span>
                            <span class="font-black text-green-400">ูุฌุงูู</span>
                        </div>
                        <div class="flex justify-between items-center pt-2">
                            <span class="font-black text-lg">ุงูุฅุฌูุงูู ุงูููุงุฆู</span>
                            <span class="text-4xl font-black">{{ invoice.totalAmount }} SAR</span>
                        </div>
                    </div>
                </div>

                <div class="mt-32 text-center">
                    <div class="inline-block border-2 border-gray-100 px-10 py-4 rounded-full text-gray-400 font-black text-sm uppercase tracking-widest">
                        ุดูุฑุงู ูุซูุชูู ุจูููุฉ ุจูุชู - ูุณุนุฏ ุจุฎุฏูุชูู ุฏุงุฆูุงู
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const { createApp, ref, computed, onMounted, watchEffect } = Vue;

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hwayt-bytk-v1';
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxa6rmwo_4kCorqvihWtNcgy6hlZKLMcSJnNr_m8kp0h-vLATsiUVcDyoUXuuQuJBTn/exec";

        createApp({
            setup() {
                const activeTab = ref('create');
                const user = ref(null);
                const orders = ref([]);
                const catalog = ref([]);
                const loading = ref(true);
                const notification = ref(null);
                const searchQuery = ref('');
                const filterDate = ref(new Date().toISOString().split('T')[0]);
                const isSaving = ref(false);
                const bulkList = ref([]);

                const orderForm = ref({
                    client: { name: '', city: '', address: '', phone: '' },
                    products: [{ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0 }]
                });

                const catalogForm = ref({ name: '', price: '' });

                onMounted(async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) { console.error("Auth Failure:", err); }

                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        if (u) {
                            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snap) => {
                                orders.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                loading.value = false;
                            }, (err) => console.error("Orders Error:", err));

                            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'catalog'), (snap) => {
                                catalog.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            }, (err) => console.error("Catalog Error:", err));
                        }
                    });
                });

                const showNotify = (msg, type = 'success') => {
                    notification.value = { msg, type };
                    setTimeout(() => { notification.value = null; }, 4000);
                    setTimeout(() => lucide.createIcons(), 100);
                };

                const addProductRow = () => {
                    orderForm.value.products.push({ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0 });
                };

                const removeProductRow = (idx) => {
                    orderForm.value.products.splice(idx, 1);
                };

                const syncProductData = (p) => {
                    const item = catalog.value.find(c => c.id === p.productId);
                    if (item) { p.name = item.name; p.price = item.price; }
                };

                const calculateTotal = () => {
                    return orderForm.value.products.reduce((sum, p) => sum + (p.price * p.count), 0);
                };

                const saveOrder = async () => {
                    if (!user.value) { showNotify("ุงูุฑุฌุงุก ุงูุชุธุงุฑ ุงูุงุชุตุงู...", "error"); return; }
                    isSaving.value = true;
                    
                    const orderId = 'ORD-' + Math.random().toString(36).substr(2, 8).toUpperCase();
                    const totalAmount = calculateTotal();
                    
                    const payload = {
                        orderId,
                        client: { ...orderForm.value.client },
                        products: [...orderForm.value.products],
                        totalAmount,
                        timestamp: new Date().toISOString()
                    };

                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), payload);
                        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                        showNotify(`ุชู ุญูุธ ุงูุทูุจ: ${orderId}`);
                        orderForm.value = {
                            client: { name: '', city: '', address: '', phone: '' },
                            products: [{ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0 }]
                        };
                        activeTab.value = 'archive';
                    } catch (e) { showNotify("ูุดู ูู ุงูุญูุธ", "error"); } finally { isSaving.value = false; }
                };

                const deleteOrder = async (id) => {
                    if (confirm("ูู ุฃูุชู ูุชุฃูุฏุฉ ูู ุญุฐู ูุฐุง ุงูุทูุจ ููุงุฆูุงู ูู ุงูุฃุฑุดููุ")) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
                        showNotify("ุชู ุญุฐู ุงูุทูุจ");
                    }
                };

                const saveCatalogItem = async () => {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'catalog'), catalogForm.value);
                    catalogForm.value = { name: '', price: '' };
                    showNotify("ุชูุช ุฅุถุงูุฉ ุงูููุชุฌ ูููุชุงููุฌ");
                };

                const deleteCatalogItem = async (id) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'catalog', id));
                };

                const viewInvoice = (order) => {
                    bulkList.value = [order];
                    setTimeout(() => window.print(), 200);
                };

                const printBulk = () => {
                    if (filteredByDateOrders.value.length === 0) {
                        showNotify("ูุง ุชูุฌุฏ ููุงุชูุฑ ูู ุงูุชุงุฑูุฎ ุงููุฎุชุงุฑ", "error");
                        return;
                    }
                    bulkList.value = filteredByDateOrders.value;
                    setTimeout(() => window.print(), 200);
                };

                const filteredOrders = computed(() => {
                    const q = searchQuery.value.toUpperCase();
                    return orders.value.filter(o => 
                        o.orderId.includes(q) || 
                        o.client.name.includes(searchQuery.value) ||
                        o.client.phone.includes(searchQuery.value)
                    ).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                });

                const filteredByDateOrders = computed(() => {
                    return orders.value.filter(o => o.timestamp.split('T')[0] === filterDate.value);
                });

                const formatDate = (ts) => new Date(ts).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                const formatTime = (ts) => new Date(ts).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

                watchEffect(() => { setTimeout(() => lucide.createIcons(), 100); });

                return {
                    activeTab, orders, catalog, loading, notification, searchQuery, filterDate, isSaving,
                    orderForm, catalogForm, bulkList,
                    addProductRow, removeProductRow, syncProductData, saveOrder, deleteOrder,
                    saveCatalogItem, deleteCatalogItem, viewInvoice, printBulk, calculateTotal,
                    filteredOrders, filteredByDateOrders, formatDate, formatTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>