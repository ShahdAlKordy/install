<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هوية بيتك - تسجيل الطلبات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc;
        }
        .navy-bg { background-color: #001f3f; }
        .navy-text { color: #001f3f; }
        .navy-border { border-color: #001f3f; }
        .btn-primary {
            background-color: #001f3f;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #003366;
            transform: translateY(-2px);
        }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            border-color: #001f3f;
            box-shadow: 0 0 0 2px rgba(0, 31, 63, 0.1);
        }
        #loadingOverlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            align-items: center;
            justify-content: center;
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loadingOverlay">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p>جاري رفع البيانات والصور... يرجى الانتظار</p>
        </div>
    </div>

    <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
        <!-- Header -->
        <div class="navy-bg p-6 text-center">
            <img src="logo1.png" alt="هوية بيتك" class="h-20 mx-auto mb-4 object-contain rounded" onerror="this.src='https://via.placeholder.com/150x80?text=Logo'">
            <h1 class="text-white text-xl font-bold">بوابة تسجيل المندوبين</h1>
        </div>

        <form id="orderForm" class="p-6 space-y-6">
            <!-- Region Selection -->
            <div>
                <label class="block text-sm font-bold navy-text mb-2">المنطقة</label>
                <select id="region" name="region" class="input-field" required onchange="filterNames()">
                    <option value="">اختر المنطقة</option>
                    <option value="الرياض">الرياض</option>
                    <option value="تبوك">تبوك</option>
                    <option value="الغربيه">المنطقة الغربية</option>
                    <option value="الشرقية">المنطقة الشرقية</option>
                    <option value="حائل">حائل</option>
                    <option value="الجنوبية">المنطقة الجنوبية</option>
                </select>
            </div>

            <!-- Name Selection (Dynamic) -->
            <div>
                <label class="block text-sm font-bold navy-text mb-2">اسم المندوب</label>
                <select id="delegateName" name="delegateName" class="input-field" required disabled>
                    <option value="">اختر المنطقة أولاً</option>
                </select>
            </div>

            <hr class="border-gray-100">

            <!-- Order Data -->
            <div>
                <label class="block text-sm font-bold navy-text mb-2">رقم الطلب</label>
                <input type="text" name="orderNumber" class="input-field" placeholder="أدخل رقم الطلب" required>
            </div>

            <div>
                <label class="block text-sm font-bold navy-text mb-2">العنوان الوطني</label>
                <textarea name="nationalAddress" class="input-field" rows="2" placeholder="أدخل العنوان الوطني بالتفصيل" required></textarea>
            </div>

            <div>
                <label class="block text-sm font-bold navy-text mb-2">عدد لوحات الطلب</label>
                <input type="number" name="platesCount" class="input-field" placeholder="0" required min="1">
            </div>

            <!-- Photo Upload -->
            <div>
                <label class="block text-sm font-bold navy-text mb-2">رفع صور الطلب (يمكنك اختيار أكثر من صورة)</label>
                <input type="file" id="photos" name="photos" class="input-field" multiple accept="image/*" required>
                <p class="text-xs text-gray-500 mt-1">يُفضل رفع الصور بصيغة JPG أو PNG</p>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="w-full btn-primary font-bold py-3 px-4 rounded-lg shadow-md">
                إرسال البيانات للجدول
            </button>
        </form>

        <!-- Feedback Message -->
        <div id="message" class="hidden p-4 mx-6 mb-6 rounded-lg text-center font-bold"></div>
    </div>

    <script>
        const delegates = [
            { name: "صالح جبران", region: "الرياض" },
            { name: "امجد الحداد", region: "الرياض" },
            { name: "رضوان الحداد", region: "الجنوبية" },
            { name: "محمد نجيب", region: "الغربيه" },
            { name: "محمد نجيب", region: "الرياض" },
            { name: "أحمد معان", region: "الغربيه" },
            { name: "عمر الزبيدي", region: "الرياض" },
            { name: "سامي عمر", region: "حائل" },
            { name: "جميل محيرز", region: "الرياض" },
            { name: "رامي", region: "الشرقية" },
            { name: "سالم", region: "الشرقية" },
            { name: "ناصر", region: "الشرقية" },
            { name: "محمد عامر", region: "الرياض" },
            { name: "صالح اليافعي", region: "الشرقية" },
            { name: "سالم نيازي", region: "الشرقية" },
            { name: "علي عبد الرحمن", region: "الشرقية" }
        ];

        // ⚠️ استبدل هذا الرابط برابط الـ Web App الخاص بك بعد نشر Apps Script
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-SZ5Hhfq9TaOmZh0-y805woldquEv_vE410S9UOwLvrX0fvaGSVwauefbxjNe01F83A/exec";

        function filterNames() {
            const regionSelect = document.getElementById('region');
            const nameSelect = document.getElementById('delegateName');
            const selectedRegion = regionSelect.value;

            nameSelect.innerHTML = '<option value="">اختر الاسم</option>';
            
            if (selectedRegion) {
                const filtered = delegates.filter(d => d.region === selectedRegion);
                filtered.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.name;
                    opt.textContent = d.name;
                    nameSelect.appendChild(opt);
                });
                nameSelect.disabled = false;
            } else {
                nameSelect.disabled = true;
            }
        }

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (WEB_APP_URL === "YOUR_SCRIPT_URL_HERE") {
                showMessage("خطأ: يرجى ربط كود الـ Apps Script أولاً", "bg-red-100 text-red-700");
                return;
            }

            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';

            const form = e.target;
            const formData = new FormData(form);
            const files = document.getElementById('photos').files;
            
            // تحويل الصور لـ Base64 لسهولة النقل عبر Script
            const photoPromises = Array.from(files).map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({
                        name: file.name,
                        type: file.type,
                        data: e.target.result.split(',')[1]
                    });
                    reader.readAsDataURL(file);
                });
            });

            const photosBase64 = await Promise.all(photoPromises);

            const payload = {
                region: formData.get('region'),
                delegateName: formData.get('delegateName'),
                orderNumber: formData.get('orderNumber'),
                nationalAddress: formData.get('nationalAddress'),
                platesCount: formData.get('platesCount'),
                photos: photosBase64
            };

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showMessage("تم إرسال البيانات والتحميل بنجاح ✅", "bg-green-100 text-green-700");
                    form.reset();
                    document.getElementById('delegateName').disabled = true;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showMessage("حدث خطأ أثناء الإرسال: " + error.message, "bg-red-100 text-red-700");
            } finally {
                overlay.style.display = 'none';
            }
        });

        function showMessage(text, classes) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = text;
            msgDiv.className = `p-4 mx-6 mb-6 rounded-lg text-center font-bold ${classes}`;
            msgDiv.classList.remove('hidden');
        }
    </script>
</body>
</html>

